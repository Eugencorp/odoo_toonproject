<?xml version="1.0"?>
<odoo>
  <data>
  	<record model="ir.ui.view" id="comment_session_custom_list">
      <field name="name">comment_session.list</field>
      <field name="model">toonproject.comment_session</field>
      <field name="arch" type="xml">
		<tree create="false" import="false">
			<field name="author"/>
			<field name="date" string="комментарии" />
			<field name="video_date" string="видео" />
			<button string="..." name = "open_sessions" type="object"/>
		</tree>									
      </field>
    </record>
	
    <record model="ir.actions.act_window" id="toonproject.task_comments_action">
        <field name="name">Комментарии</field>
        <field name="res_model">toonproject.comment_session</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree,form</field>
		<field name="target">new</field>
        <field name="view_id" ref="comment_session_custom_list"/>
    </record>
	
    <record model="ir.ui.view" id="toonproject_group_form_view">
        <field name="name">group.form</field>
        <field name="model">res.groups</field>
        <field name="priority" eval="50"/>
        <field name="arch" type="xml">
            <form string="Группа">
                <sheet>
                    <group>
                        <field name="category_id" readonly="1"/>
                        <field name="name" string="Группа"/>
                        <field name="comment" string="Описание"/>
                        <field name="users" string="Участники группы"/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <record model="ir.ui.view" id="cartoon_form_view">
        <field name="name">cartoon.form</field>
        <field name="model">toonproject.cartoon</field>
        <field name="arch" type="xml">
            <form string="Project Form">
                <sheet>
                    <group>
                        <field name="name" string="Проект"/>
                        <field name="parent_id" string="Родительский проект"/>
                        <field colspan="2" name="description" string="Описание"/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <record model="ir.ui.view" id="price_form_view">
        <field name="name">price.form</field>
        <field name="model">toonproject.price</field>
        <field name="arch" type="xml">
            <form string="Price Form">
                <sheet>
					<field name="id" id="price_id" invisible="1"/>
					<label for="project_id"/>
					<field name="project_id" string="Проект"/>
					<br/>
					
					<label for="tasktype_id"/>
					<field name="tasktype_id" string="Процесс"/>
					<br/>
					
					<label for="value"/>
					<field name="value" string="Стоимость"/>
					<br/>						
					
					<label for="controlers"/>
					<field name="controlers" string="контроль" context="{'default_price':id}" >
					  <tree>
						<field name="sequence" widget="handle"/>
						<field name="name"/>
					  </tree>
					</field>
					<br/>
					
					<label for="valid_group"/>
					<field name="valid_group" string="Группа исполнителей"
					  domain="[('category_id','=', %(module_category_toonproject)d)]"/>
					<div class="param_group"> 
						<h2>Загрузка preview</h2>
						<div class="param">
							<label for="check_preview"/>
							<field name="check_preview"/>
						</div>
						<div class="param">	
							<label for="preview_server_setting"/>
							<field name="preview_server_setting"/>
							<br/>
							<label for="preview_subfolder"/>
							<field name="preview_subfolder"/>
						</div>	
						<span attrs="{'invisible':[('preview_server_setting','!=',False)]}">
							<div class="param">
								<span>Внешний путь к файлам </span>
								<field name="preview_path" widget="url" />
								<div>Например: <i>http://192.168.0.1/www/previews/</i></div>
							</div>
							
							<div class="param">
								<span>Тип интерфейса загрузки </span>
								<field name="preview_controler"/>
								<field name="preview_controler_path" invisible="1" />
							</div>
							
							<div class="param">					
								<span>Адрес для загрузки </span>
								<field name="preview_upload_path"/>
								<div class="example">Например: <i>http://192.168.0.1:443/remote.php/webdav/previews/</i>
								или <i>ftp://192.168.0.1/previews</i></div>
							</div>
						</span>
						<div class="param_subgroup">
							<h3 attrs="{'invisible':[('preview_server_setting','!=',False)]}">Юзер, от имени которого будут закачиваться файлы в хранилище:</h3>
							<span attrs="{'invisible':[('preview_server_setting','=',False)]}">
								<label for="preview_custom_user"/><field name="preview_custom_user"/><br/>
							</span>
							<span  attrs="{'invisible':[('preview_server_setting','!=',False),('preview_custom_user','=',False)]}">
								<label for="preview_login"/><field name="preview_login"/><br/>
								<label for="preview_password"/><field name="preview_password" password="True"/>
							</span>
						</div>
						<span attrs="{'invisible':[('preview_server_setting','!=',False)]}">
							<button id="test_preview_connection" string="Проверить соединение" icon="fa-television"/>
						</span>
					</div>
					<div class="param_group"> 
						<h2>Загрузка главного файла исходника</h2>
						<div class="param">
							<label for="mainsource_ext"/>
							<field name="mainsource_ext"/>
							<span style="margin-left:10px;">(например: <i>.moho</i>)</span>
						</div>						
						<div class="param">
							<label for="check_mainsource"/>
							<field name="check_mainsource"/>
						</div>
						<div class="param">	
							<label for="mainsource_server_setting"/>
							<field name="mainsource_server_setting"/>
							<br/>
							<label for="mainsource_subfolder"/>
							<field name="mainsource_subfolder"/>
						</div>	
						<span attrs="{'invisible':[('mainsource_server_setting','!=',False)]}">						
							<div class="param">
								<label for="mainsource_path"/>
								<field name="mainsource_path" widget="url" />
								<div>Например: <i>http://192.168.0.1/www/animation/</i></div>
							</div>
							
							<div class="param">
								<label for="mainsource_controler"/>
								<field name="mainsource_controler"/>
								<field name="mainsource_controler_path" invisible="1" />
							</div>
							
							<div class="param">					
								<label for="mainsource_upload_path"/>
								<field name="mainsource_upload_path"/>
								<div class="example">Например: <i>http://192.168.0.1:443/remote.php/webdav/animation/</i>
								или <i>ftp://192.168.0.1/animation</i></div>
							</div>
						</span>
						<div class="param_subgroup">
							<h3 attrs="{'invisible':[('mainsource_server_setting','!=',False)]}">Юзер, от имени которого будут закачиваться файлы в хранилище:</h3>
							<span attrs="{'invisible':[('mainsource_server_setting','=',False)]}">
								<label for="mainsource_custom_user"/><field name="mainsource_custom_user"/><br/>
							</span>
							<span  attrs="{'invisible':[('mainsource_server_setting','!=',False),('mainsource_custom_user','=',False)]}">
								<label for="mainsource_login"/><field name="mainsource_login"/><br/>
								<label for="mainsource_password"/><field name="mainsource_password" password="True"/>
							</span>
						</div>
						<span attrs="{'invisible':[('mainsource_server_setting','!=',False)]}">	
							<button id="test_mainsource_connection" string="Проверить соединение" icon="fa-television"/>
						</span>
					</div>					
                </sheet>
				<script>
                      jQuery('#test_preview_connection').click(function(e){
                      const fd = new FormData();
                      fd.append('price',  jQuery('[name=id]').text());
					  fd.append('purpose',  'preview');
                      const xhr = new XMLHttpRequest();
                      xhr.onload = () => {
                        if (xhr.status >= 200 &amp;&amp; xhr.status &lt; 300) {
                          alert("Все зашибись!");
                        } else alert("Что-то пошло не так.\n Ошибка " + xhr.status + "\n" + xhr.responseText);  
						jQuery('html').unblock();
                      };
                      adress = jQuery('[name=preview_controler_path]').text();
                      xhr.open('POST', adress, true);
                      xhr.send(fd);
                      jQuery('html').block();
                      });
                      jQuery('#test_mainsource_connection').click(function(e){
                      const fd = new FormData();
                      fd.append('price',  jQuery('[name=id]').text());
					  fd.append('purpose',  'mainsource');
                      const xhr = new XMLHttpRequest();
                      xhr.onload = () => {
                        if (xhr.status >= 200 &amp;&amp; xhr.status &lt; 300) {
                          alert("Все зашибись!");
                        } else alert("Что-то пошло не так.\n Ошибка " + xhr.status + "\n" + xhr.responseText);  
						jQuery('html').unblock();
                      };
                      adress = jQuery('[name=mainsource_controler_path]').text();
                      xhr.open('POST', adress, true);
                      xhr.send(fd);
                      jQuery('html').block();
                      });					  
                </script>
            </form>
        </field>
    </record>

    <record model="ir.ui.view" id="asset_form_view">
        <field name="name">asset.form</field>
        <field name="model">toonproject.asset</field>
        <field name="arch" type="xml">
            <form string="Asset Form">
                <sheet>
                    <group>
                        <group>
							<span id="asset_id"><field name="id" invisible="1"/></span>
                            <field name="project_id" string="Проект: "/>
                            <field name="name" string="Название"/>
                            <field name="assettype_id" string="Тип:"/>
                            <field name="short_description" string="Краткое описание:"/>
                            <field name="size" string="Размер:"/>
							<field name="factor" string="Ориентировочная сложность"/>
                        </group>
                        <group>
							<div class="row">
							<label for="description" class="col-12"/>
                            <field name="description" string="Длинное описание:" class="col-12"/>
							<div class="col-6">
								<div style="text-align: center; font-weight:bold;">Иконка:</div>
								<field name="icon_image" widget="image"/>
							</div>
							<div class="smallpreview col-6">
								<div style="text-align: center; font-weight:bold;">Исходное видео:</div> 
								<field name="preceding_preview"  widget="video_preview" />
							</div>

                            </div>                       
                        </group>
                    </group>
					<div class="row">
						<div class="col-6">
							<label for="task_ids"/>
							<field name="task_ids" context="{'default_asset_ids':[id]}">
							  <tree class="no_open" default_order="tasktype_sequence">
								<button name="open_task_view_py" string="смотреть" type="object"/>
								<field name="tasktype_sequence" invisible="1"/>
								<field name="name" string="задача"/>
								<field name="tasktype_id" string="вид работ"/>
								<field name="worker_id" string="исполнитель"/>
								<field name="status" string="статус"/>
							  </tree>
							</field>
						</div>
						<div class="col-3">
							<div style="text-align: center; font-weight:bold; margin-bottom:10px;">Исходники</div>
							<label for="last_mainsource"/>
							<field name="last_mainsource" widget="url"/>
							<div style="margin-top:10px;">другие файлы</div>
						</div>
						<div class="smallpreview col-3">
							<div style="text-align: center; font-weight:bold;">Последнее видео:</div> 
							<field name="last_preview"  widget="video_preview" />
							<div style="text-align: center;"><a id="open_playlist_link"><button id="open_playlist_button" string="Смотреть в монтаже" class="btn-info" /></a></div>							
						</div>
					</div>
                  <script>
                      jQuery('.no_open .o_data_row td').click(function(evt) { evt.stopPropagation(); });
					  var id = jQuery('#asset_id');
					  var playlist_url = "/toonproject/playlist?step=3" + decodeURIComponent('%26') + "current=" + id.text();
					  jQuery('#open_playlist_link').attr({'href': playlist_url, 'target':'_blank'});
                  </script>
                </sheet>
            </form>
        </field>
    </record>
    
    <record model="ir.ui.view" id="tasks_form_view">
        <field name="name">task.form</field>
        <field name="model">toonproject.task</field>
        <field name="arch" type="xml">
            <form string="Task Form">
                <sheet>
                    <notebook>
                        <page string="Задание">
                          <group>
                            <field name="name" string="Задание" attrs="{'readonly':[('isManager','=',False)]}" />
                            <field name="project_id" string="по проекту" attrs="{'readonly':[('isManager','=',False)]}" />
                            <field name="tasktype_id" string="Тип работ:" attrs="{'readonly':[('isManager','=',False)]}"/>
                            <field name="worker_id" string="Исполнитель:" attrs="{'readonly':[('isManager','=',False)]}"/>
                            <field name="status" string="Статус:" attrs="{'readonly':[('isManager','=',False)]}"/>
                          </group>
                        </page>
                        <page string="Описание">
                          <group>
                            <field name="short_description" string="Краткое содержание:" attrs="{'readonly':[('isManager','=',False)]}"/>
                            <field name="description" string="Описание задачи:" attrs="{'readonly':[('isManager','=',False)]}"/>
							<field name="factor" string="Сложность:" attrs="{'readonly':[('isManager','=',False)]}"/>
                            <field name="computed_price" string="Cтоимость:" attrs="{'invisible':[('isManager','=',False),('isWorker','=',False),'|',('isValidWorker','=',False), ('worker_id','>',0)]}" />
                          </group>
                        </page>
                        <page string="Контроль">
                          <group>
                            <field name="controler_names" string="Контролеры:"/>
                            <field name="current_control" string="Должен проверить:" domain="[('price','=',price_record)]" attrs="{'readonly':[('isManager','=',False)]}"/>
                          </group>
                        </page>
                        <page string="Сроки">
                          <group>
                            <field name="valid_group" string="Кому можно выдавать" attrs="{'invisible':[('worker_id','!=',None)],'readonly':[('isManager','=',False)]}"/>
                            <field name="work_start" string="принято в работу:" widget="date" attrs="{'readonly':[('isManager','=',False)]}"/>
                            <field name="plan_finish" string="планируемое окончание:" widget="date" attrs="{'readonly':[('isManager','=',False),'|',('plan_finish','!=',None),('isWorker','=',False)]}"/>
                            <field name="real_finish" string="фактическое окончание:" widget="date" attrs="{'readonly':[('isManager','=',False)], 'invisible':[('status','!=','5finished'),('isManager','=',False)]}" />
                          </group>
                        </page>
                        <page string="Результат">
						  <div class="row">
							<label for="pay_date" class="col-6" style="text-align: right;" />
                            <field name="pay_date" attrs="{'readonly':[('isManager','=',False)]}"/>
						  </div>
                          <div class="row">
                            <div class="col-6">
								<div style="text-align: center; font-weight:bold; font-size:larger;">Preview:</div>
								<div style="text-align: center" class="buttongap">
									<field name="preview"  widget="video_preview" attrs="{'readonly':[('isManager','=',False)]}" />
									<div attrs="{'invisible':['|',('preview_controler','=',False), '&amp;', ('isWorker','=',False),('isManager','=',False)]}">
										<button id="set_default_preview_button" class="btn-success" style="float:right;" icon="fa-refresh" help="Нажмите, если файл уже был загружен по дефолтному адресу" />
										<input type="file" class="form-control" name="uploaded_file" id="preview_file" style="display:inline;width:85%"/>						
									</div>
									<button id="open_playlist_button" string="Смотреть в монтаже" class="btn-info" />
									<button id="commenting_button" string="Комментировать" class="btn-primary" />
									<button name="task_comments_button" type="object" string="история" class="btn-light" />
								</div>
                            </div>
                            <div class="col-6" >
                              <div style="text-align: center; font-weight:bold; font-size:larger; margin-bottom:10px">Исходники:</div>
							  <div style="text-align: center; font-weight:bold; ">Главный:</div>
							  <field name="mainsource" widget = "url"/>
                              <div attrs="{'invisible':['|',('mainsource_controler','=',False), '&amp;', ('isWorker','=',False),('isManager','=',False)]}">
                                <button id="set_default_mainsource_button" class="btn-success" style="float:right;" icon="fa-refresh" help="Нажмите, если файл уже был загружен по дефолтному адресу" />
								<input type="file" class="form-control" name="uploaded_file" id="mainsource_file" style="display:inline;width:85%"/>						
                              </div>
							  <div style="text-align: center; font-weight:bold; margin-top:10px;">Остальные:</div>							  
                            </div>
                          </div>
                        </page>
                        <page string="Aдминистрирование" groups="toonproject.group_toonproject_manager">
                          <group>
                            <group>
                              <field name="valid_group" string="Кто может брать в работу" groups="toonproject.group_toonproject_manager,toonproject.group_toonproject_admin" domain="[('category_id','=', %(module_category_toonproject)d)]"/>
                              <field name="compute_price_method" string="Способ рассчета стоимости:" groups="toonproject.group_toonproject_manager,toonproject.group_toonproject_admin"/>
                              <field name="preview_filename" attrs="{'readonly': [('isManager', '=', False)]}" string="Имя файла по умолчанию" />
                            </group>
                            <group>
                              <field name="factor" string="Сложность:" attrs="{'readonly':[('isManager','=',False)]}"/>
                              <field name="computed_price" string="Cтоимость:"/>
                            </group>

                          </group>
                        </page>
                        <page string="Служебное" groups="toonproject.group_toonproject_admin">
                          <group>
							<field name="id" id="task_id" invisible="1"/>
                            <field name="isManager"  invisible="0"/>
                            <field name="isControler" invisible="0"/>
                            <field name="isWorker" invisible="0"/>
                            <field name="isValidWorker" invisible="0"/>

                            <field name="price_record" string="расценка"/>
                            <field name="preview_controler" />
                            <field name="mainsource_controler" />							
							<field name="pause_reason" />
							<field name="main_asset"/>

                          </group>
                        </page>
                    </notebook>
                    <script>
                      jQuery('td.o_td_label+td').each(function(i,el){el.style.width = null;});
                      jQuery('table.o_group').each(function(i,el){el.style.width = 'auto';});
                      jQuery('#preview_file').change(function(e){
                      const fd = new FormData();
                      Array.from(e.target.files).forEach((file) => {
                        fd.append(e.target.name, file, file.name);
                      });
                      fd.append('task',  jQuery('[name=id]').text());
					  fd.append('purpose', 'preview');
                      const xhr = new XMLHttpRequest();
                      xhr.onload = () => {
                        if (xhr.status >= 200 &amp;&amp; xhr.status &lt; 300) {
                          alert("Файл загружен");
                          video = jQuery('.o_video_preview video');
                          video.attr('src', xhr.response + "?" + Math.random());
                          video[0].load();
                          jQuery('.o_video_preview').removeClass('o_field_empty');
                        } else alert("Что-то пошло не так.\n Ошибка: " + xhr.status);
                        jQuery('html').unblock();
                      };
                      adress = jQuery('[name=preview_controler]').text();
                      xhr.open('POST', adress, true);
                      xhr.send(fd);
                      jQuery('html').block();
                      });
					  jQuery('#set_default_preview_button').click(function(e){
						var t = jQuery('[name=id]').text();
						t = t.replace(/\s/gi,"");
						var url = "/toonproject/default_preview?t=" + t;
						const xhr = new XMLHttpRequest();
						xhr.onload = () => {
							if(xhr.status >= 200 &amp;&amp; xhr.status &lt; 300) {
							  video = jQuery('.o_video_preview video');
							  video.attr('src', xhr.response + "?" + Math.random());
							  video[0].load();	
							  jQuery('.o_video_preview').removeClass('o_field_empty');
							}
							else alert(xhr.response);
							jQuery('html').unblock();
						};
						xhr.open('GET', url, true);
						xhr.send()
						jQuery('html').block();
					  });
					  jQuery('#open_playlist_button').click(function(e){
						var main_asset = jQuery('[name=main_asset]').attr('href');
						if(main_asset) {
							var found = main_asset.match(/#id=(\d+).*/);
							if(found){
								var url = "/toonproject/playlist?step=3" + decodeURIComponent('%26') + "current=" + found[1];
								var win = window.open(url, '_blank');
								win.focus();
							}
						}
					  });
					  jQuery('#commenting_button').click(function(e){
						//alert('Under construction');
						task_id = jQuery('[name=id]').text();
			    		task_id = task_id.replace(/\s/gi,"");
						var url = "/toonproject/comment?t=" + task_id
						var win = window.open(url, '_blank');
					  });
					  jQuery('#mainsource_file').change(function(e){
                      const fd = new FormData();
                      Array.from(e.target.files).forEach((file) => {
                        fd.append(e.target.name, file, file.name);
                      });
                      fd.append('task',  jQuery('[name=id]').text());
					  fd.append('purpose', 'mainsource');
                      const xhr = new XMLHttpRequest();
                      xhr.onload = () => {
                        if (xhr.status >= 200 &amp;&amp; xhr.status &lt; 300) {
                          alert("Файл загружен");
						  theurl = jQuery('[name=mainsource]');
						  theurl.attr('href',xhr.response);
						  theurl.text(xhr.response);
						  theurl.removeClass('o_field_empty');
                        } else alert("Что-то пошло не так.\n Ошибка: " + xhr.status);
                        jQuery('html').unblock();
                      };
                      adress = jQuery('[name=mainsource_controler]').text();
                      xhr.open('POST', adress, true);
                      xhr.send(fd);
                      jQuery('html').block();
                      });
					  jQuery('#set_default_mainsource_button').click(function(e){
						var t = jQuery('[name=id]').text();
						var url = "/toonproject/default_mainsource?t=" + t;
						const xhr = new XMLHttpRequest();
						xhr.onload = () => {
							if(xhr.status >= 200 &amp;&amp; xhr.status &lt; 300) {
							  theurl = jQuery('[name=mainsource]');
							  theurl.attr('href',xhr.response);
							  theurl.text(xhr.response);
							  theurl.removeClass('o_field_empty');
							}
							else alert(xhr.response);
							jQuery('html').unblock();
						};
						xhr.open('GET', url, true);
						xhr.send()
						jQuery('html').block();
					  });
					  
					  
					  
                    </script>
                    <group col="3">
                      <div>
                        <label for="asset_ids"/>
                        <!--<field name="asset_ids" widget="many2many_tags" attrs="{'readonly':[('isManager','=',False)]}"/>-->
                        <field name="asset_ids" attrs="{'readonly':[('isManager','=',False)]}">
                          <tree>
                            <field name="assettype_id"/>
                            <field name="name"/>
                            <field name="short_description"/>
                            <field name="size"/>
                          </tree>
                        </field>
                      </div>
                      <div>
                        <label for="affecting_tasks"/>
                          <!--<field name="affecting_tasks" widget="many2many_tags" attrs="{'readonly':[('isManager','=',False)]}"/>-->

                          <field name="affecting_tasks" attrs="{'readonly':[('isManager','=',False)]}">
                                <tree>
                                  <field name="name"/>
                                  <field name="tasktype_id"/>
                                  <field name="status"/>
                                  <field name="worker_id"/>
                                </tree>
                          </field>

                      </div>
                      <div>
                        <label for="dependent_tasks"/>
                        <field name="dependent_tasks" attrs="{'readonly':[('isManager','=',False)]}">
                              <tree>
                                <field name="name"/>
                                <field name="tasktype_id"/>
                              </tree>
                        </field>
                      </div>
                    </group>
                    <group>
                        <button name="button_start" string="взять в работу" type="object" attrs="{'invisible':['|',('isValidWorker','!=',True),'&amp;',('status','!=', '2ready'),('status','!=', '4torevision')]}" class="btn-success"/>
                        <button name="button_control" string="отправить в проверку" type="object" attrs="{'invisible':['|',('isWorker','!=',True), ('status','!=', '3progress'),('status','!=','5inrevision')]}" class="btn-danger"/>
                        <button name="button_reject" string="вернуть на доработку" type="object" attrs="{'invisible':['|',('status','!=', '6control'),('isControler','!=',True)]}" class="btn-danger"/>
                        <button name="button_accept" string="принять" type="object" attrs="{'invisible':['|',('status','!=', '6control'),('isControler','!=',True)]}" class="btn-success"/>
                    </group>

                    <div class = "oe_chatter" style="display:block;">
                         <field name="message_follower_ids" widget="mail_followers"/>
                         <field name="message_ids" widget="mail_thread"/>
                    </div>

                </sheet>
            </form>
        </field>
    </record>
	
    <record model="ir.ui.view" id="tasktype_form_view">
        <field name="name">tasktype.form</field>
        <field name="model">toonproject.tasktype</field>
        <field name="arch" type="xml">
            <form string="Asset Form">
                <sheet>
					<group>
						<field name="name" />
						<field name="description" />
						<field name="valid_assettypes" widget="many2many_checkboxes"  string="Применимо к" />
						<field name="line_color"/>
					</group>
				</sheet>
			</form>
		</field>
	</record>
	


    <record model="ir.ui.view" id="toonproject_group_list">
      <field name="name">group.list</field>
      <field name="model">res.groups</field>
      <field name="type">tree</field>
      <field name="arch" type="xml">
        <tree>
          <field name="display_name" />
          <field name="comment" />
        </tree>
      </field>
    </record>

    <record model="ir.ui.view" id="tasktype_list">
      <field name="name">tasktype.list</field>
      <field name="model">toonproject.tasktype</field>
      <field name="type">tree</field>
      <field name="arch" type="xml">
        <tree>
          <field name="sequence" widget="handle"/>
          <field name="name" string="Название"/>
          <field name="description" string="Описание"/>
          <field name="valid_assettypes" widget="many2many_tags" string="Над чем производятся работы"/>
        </tree>
      </field>
    </record>

    <record model="ir.ui.view" id="cartoon_list">
      <field name="name">cartoon.list</field>
      <field name="model">toonproject.cartoon</field>
      <field name="type">tree</field>
      <field name="field_parent">children_ids</field>
      <field name="arch" type="xml">
        <tree>
          <field name="display_name" />
          <field name="parent_id" invisible="1"/>
        </tree>
      </field>
    </record>  

    <record model="ir.ui.view" id="asset_list">
      <field name="name">asset.list</field>
      <field name="model">toonproject.asset</field>
      <field name="arch" type="xml">
        <tree class="colored" decoration-danger="line_color=='pink'" decoration-warning="line_color=='orange'" decoration-success="line_color=='green'" decoration-primary="line_color=='gray'" decoration-info="line_color=='blue'" 
		decoration-it="'3progress'>=current_status>='2ready'" decoration-bf="current_status>='3progress'" >
		  <field name="line_color" invisible="1"/>
		  <field name="project_id" string="проект"/>
          <field name="assettype_id" string="тип"/>
          <field name="name" string="название"/>
          <field name="short_description" string="краткое описание:"/>
          <field name="size" string="размер"  sum="размер"/>
          <field name="current_tasktype" string="текущая задача"/>
          <field name="current_worker" string="исполнитель"/>		  
          <field name="current_status" string="статус"/>
        </tree>
      </field>
    </record>
	

    
    <record model="ir.ui.view" id="task_list">
      <field name="name">task.list</field>
      <field name="model">toonproject.task</field>
      <field name="arch" type="xml">
        <tree>
	  <field name="tasktype_sequence" invisible="1"/>
          <field name="project_id" string="проект"/>
          <field name="name" string="задача"/>
          <field name="short_description" string="содержание"/>
          <!--<field name="asset_ids" string="объект"  widget="many2many_tags" options="{'color_field':'assettype_id'}"/>-->
		  <field name="asset_names" string="материалы"/>
          <field name="tasktype_id" string="вид работ"/>
          <field name="factor" string="сложность"/>
          <field name="status" string="статус"/>          
          <field name="worker_id" string="исполнитель"/>
          <field name="work_start" string="начата"/>
          <field name="real_finish" string="закончена"/>
          <field name="write_date" string="последние изменения"/>
          <field name="computed_price" string="стоимость" sum="сумма:" groups="toonproject.group_toonproject_manager" />
          <field name="pay_date" string="оплачено"/>
        </tree>
      </field>
    </record>

    <record model="ir.ui.view" id="task_list_kanban">
      <field name="name">task.list.kanban</field>
      <field name="model">toonproject.task</field>
      <field name="arch" type="xml">
        <kanban default_group_by="status" quick_create="0" group_delete="0" group_create="0" group_edit="0">
          <field name="color"/>
          <templates>
            <t t-name="kanban-box">
              <div
                  t-attf-class="oe_kanban_color_{{kanban_getcolor(record.color.raw_value)}}
                                oe_kanban_global_click oe_semantic_html_override
                                oe_kanban_card {{record.group_fancy==1 ? 'oe_kanban_card_fancy' : ''}}">
                                <div t-attf-class="oe_kanban_content">
                                    <!-- title -->
                                    <field name="name"/>
                                    <br/>
                                    Вид работ:
                                    <field name="tasktype_id"/>
                                    <br/>
                                    Исполнитель:
                                    <field name="worker_id"/>
                                </div>
              </div>
            </t>
          </templates>
        </kanban>
      </field>
    </record>

    <record model="ir.ui.view" id="asset_list_kanban">
      <field name="name">asset.kanban</field>
      <field name="model">toonproject.asset</field>
      <field name="arch" type="xml">
        <kanban default_group_by="current_tasktype" quick_create="0" group_delete="0" group_create="0" group_edit="0">
          <field name="color"/>
          <field name="current_tasktype"/>
          <field name="icon_image"/>
          <field name="id"/>
          <templates>
            <t t-name="kanban-box">
              <div
                  t-attf-class="oe_kanban_color_{{kanban_getcolor(record.color.raw_value)}}
                                oe_kanban_global_click oe_semantic_html_override
                                oe_kanban_card {{record.group_fancy==1 ? 'oe_kanban_card_fancy' : ''}}">
                                <div t-attf-class="oe_kanban_content">
                                    <div class="row">
                                      <div class="col-md-8">
                                          <field name="assettype_id"/>
                                          <b><field name="name"/></b>
                                          <br/>
                                          <field name="size"/>
                                          <br/>
                                          <field name="short_description"/>
                                          <br/>
                                          <span class="smallstatus"><field name="current_status"/></span>										  
                                      </div>
                                      <div class="col-md-3">
                                          <div class="o_kanban_image">
                                            <img t-att-src="kanban_image('toonproject.asset', 'icon_image', record.id.raw_value)" alt="icon"/>
                                          </div>
                                      </div>
                                    </div>
                                </div>
              </div>
            </t>
          </templates>
          <script>
            jQuery('.o_column_title').each(function(i,el){if(jQuery(el).text()=='Undefined')jQuery(el).text('');})
          </script>
        </kanban>
      </field>
    </record>

    <record model="ir.ui.view" id="price_list">
      <field name="name">price.list</field>
      <field name="model">toonproject.price</field>
      <field name="arch" type="xml">
        <tree>
          <field name="sequence" widget="handle"/>
          <field name="project_id" string="проект"/>
          <field name="tasktype_id" string="вид работ"/>
          <field name="value" string="расценка"/>
          <!--<field name="next_tasktype" string="следующий процесс"/>-->
          <field name="controlers" string="контроль" widget="many2many_tags"/>
          <field name="valid_group" string="группа работников"/>
        </tree>
      </field>
    </record> 	

    <record model="ir.actions.act_window" id="cartoons_list_action">
        <field name="name">Проекты</field>
        <field name="res_model">toonproject.cartoon</field>
        <field name="domain">[]</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree,form</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">Создайте первый проект, чтобы начать работу.
            </p>
        </field>
    </record>

    <record model="ir.actions.act_window" id="assets_list_action">
        <field name="name">Материалы</field>
        <field name="res_model">toonproject.asset</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree,form,kanban</field>
	<field name="limit">300</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">Создайте первую сцену, фон или риг
            </p>
        </field>
    </record>
	


    <record model="ir.actions.act_window" id="tasktypes_list_action">
        <field name="name">Виды работ</field>
        <field name="res_model">toonproject.tasktype</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree,form</field>
    </record>
	  
    <record model="ir.actions.act_window" id="assettypes_list_action">
        <field name="name">Виды материалов</field>
        <field name="res_model">toonproject.assettype</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree,form</field>
    </record>
    
    <record model="ir.actions.act_window" id="tasks_list_action">
        <field name="name">Задачи</field>
        <field name="res_model">toonproject.task</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree,form,kanban</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">Создайте первую задачу
            </p>
        </field>
    </record>

    <record model="ir.actions.act_window" id="prices_list_action">
        <field name="name">Расценки и пайплайн</field>
        <field name="res_model">toonproject.price</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree,form</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">Добавьте расценку на какой-нибудь вид работ
            </p>
        </field>
    </record>

    <record model="ir.actions.act_window" id="groups_list_action">
        <field name="name">Группы</field>
        <field name="res_model">res.groups</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree,form</field>
        <field name="view_id" ref="toonproject_group_list"/>
        <field name="domain" eval="[('category_id','=',ref('toonproject.module_category_toonproject'))]"/>
        <field name="context" eval="{'form_view_ref':'toonproject.toonproject_group_form_view', 'default_category_id':ref('toonproject.module_category_toonproject')}"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">Создайте первую группу
            </p>
        </field>
    </record>

    <menuitem id="main_toonproject_menu" name="The Toon Project" sequence="0"/>
    <menuitem id="lists_menu" name="Списки" parent="main_toonproject_menu"/>
    <menuitem id="projects_menu" name="Проекты" parent="lists_menu"
                  action="cartoons_list_action"/>        
    <menuitem id="assets_menu" name="Материалы" parent="lists_menu"
                  action="assets_list_action"/>    
    <menuitem id="tasks_menu" name="Задачи" parent="lists_menu"
                  action="tasks_list_action"/>
    <menuitem id="tasktypes_menu" name="Виды работ" parent="lists_menu"
                  action="tasktypes_list_action"
                  groups="toonproject.group_toonproject_admin"/>
    <menuitem id="assettypes_menu" name="Виды материалов" parent="lists_menu"
                  action="assettypes_list_action"
                  groups="toonproject.group_toonproject_admin"/>	  
    <menuitem id="prices_menu" name="Расценки и пайплайн" parent="lists_menu"
                  action="prices_list_action"
                  groups="toonproject.group_toonproject_admin"/>
    <menuitem id="groups_menu" name="Группы пользователей" parent="lists_menu"
                  action="groups_list_action"
                  groups="toonproject.group_toonproject_manager"/>
    <menuitem id="video_menu" name="Видео" parent="main_toonproject_menu"/>	
    <!--<menuitem id="show_playlist_menu" name="Смотреть монтаж" parent="video_menu"
                  action="assets_playlist_action"/>--> 	

	<record model="ir.ui.view" id="createtasks_wizard_form_view">
		<field name="name">createtasks_wizard.form</field>
		<field name="model">toonproject.createtasks_wizard</field>
		<field name="arch" type="xml">
			<form string="Создать задачи">
				<group>
					<field name="asset_ids"/>
					<field name="tasktype_ids"  widget="many2many_checkboxes"/>
				</group>
				<footer>
					<button name="create_tasks" type="object"
							string="Создать" class="oe_highlight"/>
					or
					<button special="cancel" string="Отмена"/>
				</footer>
			</form>
		</field>
	</record>

	<record model="ir.ui.view" id="edittasks_wizard_form_view">
		<field name="name">edittasks_wizard.form</field>
		<field name="model">toonproject.edittasks_wizard</field>
		<field name="arch" type="xml">
			<form string="Изменить свойства выбранных задач">
        <div class="row">
          <div class="col-md-6">
            <field name="valid_group_chk"/> Группа исполнителей:
            <field name="valid_group" attrs="{'readonly':[('valid_group_chk','=',False)]}" domain="[('category_id','=', %(module_category_toonproject)d)]" />
            <br/>
            <field name="worker_id_chk"/> Исполнитель:
            <field name="worker_id"  attrs="{'readonly':[('worker_id_chk','=',False)]}"/>
            <br/>
            <field name="factor_chk"/> Сложность:
            <field name="factor"  attrs="{'readonly':[('factor_chk','=',False)]}" style="{width:20%}"/>
            <br/>
            <field name="status_chk"/> Статус:
            <field name="status"  attrs="{'readonly':[('status_chk','=',False)]}" style="{width:20%}"/>
            <br/>
			<span groups="toonproject.group_toonproject_admin">
				<field name="pay_date_chk"/> Оплачено:
				<field name="pay_date"  attrs="{'readonly':[('pay_date_chk','=',False)]}" style="{width:20%}"/>
            </span>
			<br/>			
          </div>
        </div>
				<footer>
					<button name="apply_tasks" type="object"
							string="Изменить" class="oe_highlight"/>
					or
					<button special="cancel" string="Отмена"/>
				</footer>
			</form>
		</field>
	</record>

  <record model="ir.ui.view" id="editprices_wizard_form_view">
		<field name="name">editprices_wizard.form</field>
		<field name="model">toonproject.editprices_wizard</field>
		<field name="arch" type="xml">
			<form string="Изменить настройки выбранных процессов">
        <div class="row">
          <div class="col-md-6">
			<h1>Preview</h1>
            <field name="enable_preview_path"/> <label for="preview_path"/>
            <field name="preview_path" attrs="{'readonly':[('enable_preview_path','=',False)]}" />
            <br/>
            <field name="enable_preview_controler"/> <label for="preview_controler"/>
            <field name="preview_controler" attrs="{'readonly':[('enable_preview_controler','=',False)]}" />
            <br/>
            <field name="enable_preview_upload_path"/> <label for="preview_upload_path"/>
            <field name="preview_upload_path" attrs="{'readonly':[('enable_preview_upload_path','=',False)]}" />
            <br/>
            <field name="enable_preview_login"/> <label for="preview_login"/>
            <field name="preview_login" attrs="{'readonly':[('enable_preview_login','=',False)]}" />
            <br/>
            <field name="enable_preview_password"/> <label for="preview_password"/>
            <field name="preview_password" attrs="{'readonly':[('enable_preview_password','=',False)]}" password="True" />
			<br/>
			<h1>Исходник</h1>
            <field name="enable_mainsource_path"/> <label for="mainsource_path"/>
            <field name="mainsource_path" attrs="{'readonly':[('enable_mainsource_path','=',False)]}" />
            <br/>
            <field name="enable_mainsource_controler"/> <label for="mainsource_controler"/>
            <field name="mainsource_controler" attrs="{'readonly':[('enable_mainsource_controler','=',False)]}" />
            <br/>
            <field name="enable_mainsource_upload_path"/> <label for="mainsource_upload_path"/>
            <field name="mainsource_upload_path" attrs="{'readonly':[('enable_mainsource_upload_path','=',False)]}" />
            <br/>
            <field name="enable_mainsource_login"/> <label for="mainsource_login"/>
            <field name="mainsource_login" attrs="{'readonly':[('enable_mainsource_login','=',False)]}" />
            <br/>
            <field name="enable_mainsource_password"/> <label for="mainsource_password"/>
            <field name="mainsource_password" attrs="{'readonly':[('enable_mainsource_password','=',False)]}" password="True" />
			
			
			
            <br/>
          </div>
        </div>
				<footer>
					<button name="apply_prices" type="object"
							string="Изменить" class="oe_highlight"/>
					or
					<button special="cancel" string="Отмена"/>
				</footer>
			</form>
		</field>
	</record>

  <record model="ir.ui.view" id="combinetasks_wizard_form_view">
		<field name="name">combinetasks_wizard.form</field>
		<field name="model">toonproject.combinetasks_wizard</field>
		<field name="arch" type="xml">
			<form string="Объединить задачи">
        <sheet>
          <header class="invalid_message_header">
            <field name="invalid_message" class="invalid_message_field" readonly="1"/>
          </header>
              <notebook>
                  <page string="Задание">
                    <group>
                      <field name="name" string="Задание" attrs="{'readonly':[('isManager','=',False)]}" />
                      <field name="project_id" string="по проекту" readonly="1" />
                      <field name="tasktype_id" string="Тип работ:" readony="1"/>
                      <field name="worker_id" string="Исполнитель:" attrs="{'readonly':[('isManager','=',False)]}"/>
                      <field name="status" string="Статус:" attrs="{'readonly':[('isManager','=',False)]}"/>
                    </group>
                  </page>
                  <page string="Описание">
					<div style="row">
					  <label for="short_description" class="md-col-4"/>
                      <field name="short_description" class="md-col-8" string="Краткое содержание:" attrs="{'readonly':[('isManager','=',False)]}"/>
					  <label for="description" class="md-col-4"/>
                      <field name="description" class="md-col-8"  string="Описание задачи:" attrs="{'readonly':[('isManager','=',False)]}"/>
                      <label for="factor" class="md-col-4"/>
					  <field name="factor" class="md-col-8"  string="Сложность:" attrs="{'readonly':[('isManager','=',False)]}"/>
                      <label for="computed_price" class="md-col-4"/>
					  <field name="computed_price" class="md-col-8"  string="Cтоимость:"/>
					 </div>
                  </page>
                  <page string="Контроль">
                    <group>
                      <field name="controler_names" string="Контролеры:"/>
                      <field name="current_control" string="Должен проверить:" domain="[('price','=',price_record)]" attrs="{'readonly':[('isManager','=',False)]}"/>
                    </group>
                  </page>
                  <page string="Сроки">
                    <group>
                      <field name="valid_group" string="Кому можно выдавать" attrs="{'invisible':[('worker_id','!=',None)],'readonly':[('isManager','=',False)]}"/>
                      <field name="work_start" string="принято в работу:" widget="date" attrs="{'readonly':[('isManager','=',False)]}"/>
                      <field name="plan_finish" string="планируемое окончание:" widget="date" attrs="{'readonly':[('isManager','=',False),'|',('plan_finish','!=',None),('isWorker','=',False)]}"/>
                      <field name="real_finish" string="фактическое окончание:" widget="date" attrs="{'readonly':[('isManager','=',False)], 'invisible':[('status','!=','5finished'),('isManager','=',False)]}" />
                    </group>
                  </page>
                  <page string="Результат">
                    <group>
                    </group>
                  </page>
                  <page string="Aдминистрирование" groups="toonproject.group_toonproject_manager">
                    <group>
                      <group>
                        <field name="valid_group" string="Кто может брать в работу" groups="toonproject.group_toonproject_manager,toonproject.group_toonproject_admin" domain="[('category_id','=', %(module_category_toonproject)d)]"/>
                        <field name="compute_price_method" string="Способ рассчета стоимости:" groups="toonproject.group_toonproject_manager,toonproject.group_toonproject_admin"/>
                      </group>
                      <group>
                        <field name="factor" string="Сложность:" attrs="{'readonly':[('isManager','=',False)]}"/>
                        <field name="computed_price" string="Cтоимость:"/>
                      </group>
                    </group>
                  </page>
                  <page string="Служебное" groups="toonproject.group_toonproject_admin">
                    <group>
                      <field name="isManager"  invisible="0"/>
                      <field name="isControler" invisible="0"/>
                      <field name="isWorker" invisible="0"/>
                      <field name="isValidWorker" invisible="0"/>
                      <field name="price_record" string="расценка" groups="toonproject.group_toonproject_admin"/>
                    </group>
                  </page>
              </notebook>
              <script>
                jQuery('td.o_td_label+td').each(function(i,el){el.style.width = null;});
                jQuery('table.o_group').each(function(i,el){el.style.width = 'auto';});
              </script>
              <group col="3">
                <div>
                  <label for="asset_ids"/>
                  <!--<field name="asset_ids" widget="many2many_tags" attrs="{'readonly':[('isManager','=',False)]}"/>-->
                  <field name="asset_ids" attrs="{'readonly':[('isManager','=',False)]}">
                    <tree>
                      <field name="assettype_id"/>
                      <field name="name"/>
                      <field name="short_description"/>
                      <field name="size"/>
                    </tree>
                  </field>
                </div>
                <div>
                  <label for="affecting_tasks"/>
                    <!--<field name="affecting_tasks" widget="many2many_tags" attrs="{'readonly':[('isManager','=',False)]}"/>-->

                    <field name="affecting_tasks" attrs="{'readonly':[('isManager','=',False)]}">
                          <tree>
                            <field name="name"/>
                            <field name="tasktype_id"/>
                            <field name="status"/>
                            <field name="worker_id"/>
                          </tree>
                    </field>

                </div>
                <div>
                  <label for="dependent_tasks"/>
                  <field name="dependent_tasks" attrs="{'readonly':[('isManager','=',False)]}">
                        <tree>
                          <field name="name"/>
                          <field name="tasktype_id"/>
                        </tree>
                  </field>
                </div>
              </group>
         </sheet>
				<footer>
				  <span attrs="{'invisible':[('invalid_message','!=',False)]}">
					<div class="row" style="{'text-align':'right';}" >
						<label for="delete_or_archive" class="col-md-6" />
						<field name="delete_or_archive" class="col-md-4" />
					</div>
					<button name="combine_tasks" type="object"
							string="Объединить" class="oe_highlight"/>

					 или </span>
					<button special="cancel" string="Отмена"/>
				</footer>
			</form>
		</field>
	</record>

	<act_window id="launch_createtasks_wizard"
				name="Создать задачи..."
				src_model="toonproject.asset"
				res_model="toonproject.createtasks_wizard"
				view_mode="form"
				target="new"
        groups="toonproject.group_toonproject_manager"
				key2="client_action_multi"/>
				
    <record id="toonproject_update_assets" model="ir.actions.server">
        <field name="name">Обновить</field>
        <field name="type">ir.actions.server</field>
        <field name="model_id" ref="model_toonproject_asset"/>		
        <field name="binding_model_id" ref="model_toonproject_asset"/>
        <field name="state">code</field>
        <field name="code">
model = env['toonproject.asset']
env.add_todo(model._fields['current_status'], records)
env.add_todo(model._fields['color'], records)
model.recompute()
env.cr.commit()
        </field>
    </record>
	
    
	
	<record id="toonproject_link_asset_tasks" model="ir.actions.server">
        <field name="name">Добавить зависимости от задач по дополнительным материалам</field>
        <field name="type">ir.actions.server</field>
        <field name="model_id" ref="model_toonproject_task"/>		
        <field name="binding_model_id" ref="model_toonproject_task"/>
		<field name="groups" ref="toonproject.group_toonproject_manager"/>
        <field name="state">code</field>
        <field name="code">
if records:
    records.link_asset_tasks()
        </field>
    </record>
	
	<record id="toonproject_link_hookup_tasks" model="ir.actions.server">
        <field name="name">Добавить зависимости между задачами, чтобы монтировались</field>
        <field name="type">ir.actions.server</field>
        <field name="model_id" ref="model_toonproject_task"/>		
        <field name="binding_model_id" ref="model_toonproject_task"/>
		<field name="groups" ref="toonproject.group_toonproject_manager"/>
        <field name="state">code</field>
        <field name="code">
if records:
    records.link_hookup()
        </field>
    </record>	
	
    <record id="toonproject_update_tasks" model="ir.actions.server">
        <field name="name">Обновить</field>
        <field name="type">ir.actions.server</field>
        <field name="model_id" ref="model_toonproject_task"/>		
        <field name="binding_model_id" ref="model_toonproject_task"/>
        <field name="state">code</field>
        <field name="code">
model = env['toonproject.task']
env.add_todo(model._fields['pause_reason'], records)
model.recompute()
env.cr.commit()
        </field>
    </record>

	

	<act_window id="launch_edittasks_wizard"
				name="Редактировать выбранное..."
				src_model="toonproject.task"
				res_model="toonproject.edittasks_wizard"
				view_mode="form"
				target="new"
        groups="toonproject.group_toonproject_manager"
				key2="client_action_multi"/>

	<act_window id="launch_combinetasks_wizard"
				name="Объединить выбранные задачи..."
				src_model="toonproject.task"
				res_model="toonproject.combinetasks_wizard"
				view_mode="form"
				target="new"
        groups="toonproject.group_toonproject_manager"
				key2="client_action_multi"/>

  <act_window id="launch_editprices_wizard"
    name="Редактировать выбранное..."
    src_model="toonproject.price"
    res_model="toonproject.editprices_wizard"
    view_mode="form"
    target="new"
    groups="toonproject.group_toonproject_manager"
    key2="client_action_multi"/>

    <template id="assets_end" inherit_id="web.assets_backend">
        <xpath expr="." position="inside">
            <script src="/toonproject/static/src/js/widgets.js" type="text/javascript" />
        </xpath>
    </template>

  </data>
</odoo>
